version: '3.8'

services:

  # 1. Eureka Service Registry
  service-registry:
    build:
      context: ./service-registry
      dockerfile: Dockerfile
    container_name: service-registry-container
    ports:
      - "8761:8761"
    networks:
      - microservice-net
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8761/"]
      interval: 5s
      timeout: 2s
      retries: 10

  # 2. API Gateway
  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    container_name: api-gateway-container
    ports:
      - "8080:8080"
    networks:
      - microservice-net
    depends_on:
      service-registry:
        condition: service_healthy
    restart: always

  # 3. Event Service (Spring Boot)
  event-service:
    build:
      context: ./event-service
      dockerfile: Dockerfile
    container_name: event-service-container
    ports:
      - "8081:8081"
    environment:
      SPRING_PROFILES_ACTIVE: dev
      DB_URL: ${EVENT_DB_URL}
      DB_USERNAME: ${EVENT_DB_USERNAME}
      DB_PASSWORD: ${EVENT_DB_PASSWORD}
      CLOUDINARY_CLOUD_NAME: ${CLOUDINARY_CLOUD_NAME}
      CLOUDINARY_API_KEY: ${CLOUDINARY_API_KEY}
      CLOUDINARY_API_SECRET: ${CLOUDINARY_API_SECRET}
    networks:
      - microservice-net
    depends_on:
      service-registry:
        condition: service_healthy
    restart: always

  # 4. User Service (Flask)
  user-service:
    build:
      context: ./user-service
      dockerfile: Dockerfile
    container_name: user-service-container
    ports:
      - "8082:8082"
    environment:
      HOST: user-service
      MONGO_URI: ${USER_MONGO_URI}
      SECRET_KEY: ${USER_SECRET_KEY}
      OTP_EXPIRY_MINUTES: ${USER_OTP_EXPIRY_MINUTES}
      EUREKA_SERVER: http://service-registry:8761/eureka
      KAFKA_BROKER: ${KAFKA_BROKER}
      KAFKA_TOPIC: ${KAFKA_TOPIC}
    networks:
      - microservice-net
    depends_on:
      service-registry:
        condition: service_healthy
      kafka:
        condition: service_started
    restart: always

  # 5. Node Event Registration Service
  event-registration-service:
    build:
      context: ./event-registration-service
      dockerfile: Dockerfile
    container_name: event-registration-container
    ports:
      - "8083:8083"
    environment:
      PORT: 8083
      DB_HOST: ${REG_DB_HOST}
      DB_PORT: ${REG_DB_PORT}
      DB_USER: ${REG_DB_USER}
      DB_PASSWORD: ${REG_DB_PASSWORD}
      DB_NAME: ${REG_DB_NAME}
      EUREKA_HOST: service-registry
      EUREKA_PORT: 8761
      KAFKA_BROKER: ${KAFKA_BROKER}
      KAFKA_TOPIC: ${KAFKA_TOPIC}
    networks:
      - microservice-net
    depends_on:
      service-registry:
        condition: service_healthy
    restart: always

  # 6. Zookeeper
  zookeeper:
    image: confluentinc/cp-zookeeper:7.3.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    healthcheck:
      test: ["CMD", "echo", "ruok", "|", "nc", "localhost", "2181"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - microservice-net

  # 7. Kafka
  kafka:
    image: confluentinc/cp-kafka:7.3.0
    container_name: kafka
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    networks:
      - microservice-net

  # 8. Notification Service (Node)
  notification-service:
    build:
      context: ./notification-service
      dockerfile: Dockerfile
    container_name: notification-container
    ports:
      - "8084:8084"
    environment:
      KAFKA_BROKER: ${KAFKA_BROKER}
      KAFKA_TOPIC: ${KAFKA_TOPIC}
      EMAIL_USER: ${EMAIL_USER}
      EMAIL_PASS: ${EMAIL_PASS}
      EUREKA_HOST: service-registry
      EUREKA_PORT: 8761
    networks:
      - microservice-net
    depends_on:
      service-registry:
        condition: service_healthy
      kafka:
        condition: service_started
    restart: always

networks:
  microservice-net:
    driver: bridge

version: '3.8'

services:
  # 1. Spring Boot Service Registry (Eureka)
  service-registry:
    # Points to the Dockerfile in the 'service-registry' folder
    build:
      context: ./service-registry 
      dockerfile: Dockerfile
    container_name: service-registry-container
    ports:
      - "8761:8761" 
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8761/"]
      interval: 5s
      timeout: 2s
      retries: 10
    networks:
      - microservice-net
    restart: always

  # 2. spring boot api gateway
  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    container_name: api-gateway-container
    ports:
      - "8080:8080" 
    networks:
      - microservice-net
    depends_on:
      service-registry:
        condition: service_healthy
    restart: always

  # 3. Spring Boot Event Service
  event-service:
    build:
      context: ./event-service
      dockerfile: Dockerfile
    container_name: event-service-container
    ports:
      - "8081:8081"
    networks:
      - microservice-net
    depends_on:
      service-registry:
        condition: service_healthy
    environment:
      # Use the 'dev' profile for configuration specific to the development environment
      - SPRING_PROFILES_ACTIVE=dev


  # 4. Flask User Service
  user-service:
    build:
      context: ./user-service
      dockerfile: Dockerfile
    container_name: user-service-container
    ports:
      - "8082:8082"
    networks:
      - microservice-net
    depends_on:
      service-registry:
        condition: service_healthy
    restart: always

  # 5. Node Event Registration Service
  event-registration-service:
    build:
      context: ./event-registration-service
      dockerfile: Dockerfile
    container_name: event-registration-container
    ports:
      - "8083:8083"
    environment:
      - EUREKA_HOST=service-registry
      - EUREKA_PORT=8761
    networks:
      - microservice-net
    depends_on:
      service-registry:
        condition: service_healthy
    restart: always

networks:
  microservice-net:
    driver: bridge
